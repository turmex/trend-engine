{% from "helpers.j2" import wow_badge %}
{# ════ GOOGLE TRENDS ════ #}

{# ──── GROUPED VIEW (body-part signal groups) ──── #}
{% if analysis and analysis.body_part_groups and analysis.body_part_groups | length > 0 %}
<div style="padding:24px;">
    <h2 style="font-size:17px;margin:0 0 4px;color:#1e293b;">Google Trends &mdash; Body-Part Signal Groups</h2>
    <p style="font-size:12px;color:#6b7280;margin:0 0 16px;">Keywords grouped by anatomical region, ranked by composite score (volume + momentum + stability)</p>

    <table style="width:100%;border-collapse:collapse;font-size:13px;">
        <thead>
            <tr style="background:#f8fafc;">
                <th style="padding:8px 10px;text-align:left;font-weight:600;color:#475569;border-bottom:2px solid #e2e8f0;">Body Part</th>
                <th style="padding:8px 10px;text-align:left;font-weight:600;color:#475569;border-bottom:2px solid #e2e8f0;">Lead Keyword</th>
                <th style="padding:8px;text-align:center;font-weight:600;color:#475569;border-bottom:2px solid #e2e8f0;min-width:120px;">Composite</th>
                <th style="padding:8px;text-align:center;font-weight:600;color:#475569;border-bottom:2px solid #e2e8f0;">WoW</th>
                <th style="padding:8px;text-align:center;font-weight:600;color:#475569;border-bottom:2px solid #e2e8f0;">Keywords</th>
            </tr>
        </thead>
        <tbody>
        {% for grp in analysis.body_part_groups[:8] %}
        <tr style="{% if loop.index is odd %}background:#ffffff;{% else %}background:#f8fafc;{% endif %}">
            {# Group label #}
            <td style="padding:10px 10px;border-bottom:1px solid #e2e8f0;vertical-align:top;">
                <div style="font-weight:700;color:#1e293b;">{{ grp.label }}</div>
            </td>

            {# Lead keyword + sub-members #}
            <td style="padding:10px 10px;border-bottom:1px solid #e2e8f0;vertical-align:top;">
                <div style="font-weight:500;color:#1e293b;">{{ grp.lead_keyword }}</div>
                {% if grp.members | length > 1 %}
                <div style="font-size:11px;color:#6b7280;margin-top:4px;line-height:1.5;">
                    {% for m in grp.members %}
                    {% if m.keyword != grp.lead_keyword %}
                    <span style="display:inline-block;margin-right:6px;">{{ m.keyword }} <span style="color:#9ca3af;">({{ m.current }})</span></span>
                    {% endif %}
                    {% endfor %}
                </div>
                {% endif %}
            </td>

            {# Composite score bar #}
            <td style="padding:10px 8px;border-bottom:1px solid #e2e8f0;vertical-align:top;text-align:center;">
                <div style="display:inline-block;width:100%;max-width:120px;text-align:left;">
                    <div style="background:#e5e7eb;border-radius:4px;height:14px;width:100%;overflow:hidden;">
                        <div style="background:#16a34a;height:14px;border-radius:4px;width:{{ (grp.group_composite * 100) | round(0) | int }}%;min-width:2px;"></div>
                    </div>
                    <div style="font-size:11px;color:#475569;margin-top:2px;text-align:center;">{{ "%.0f"|format(grp.group_composite * 100) }}%</div>
                </div>
            </td>

            {# Lead WoW badge #}
            <td style="padding:10px 8px;border-bottom:1px solid #e2e8f0;text-align:center;vertical-align:top;">
                {{ wow_badge(grp.lead_wow_pct) }}
            </td>

            {# Member count #}
            <td style="padding:10px 8px;border-bottom:1px solid #e2e8f0;text-align:center;vertical-align:top;color:#475569;">
                {{ grp.member_count }}
            </td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

{# ──── FLAT VIEW (all keywords) ──── #}
{% if analysis and analysis.google_trends and analysis.google_trends.keywords %}
<div style="padding:24px;">
    <h2 style="font-size:17px;margin:0 0 4px;">
        {%- if analysis.body_part_groups and analysis.body_part_groups | length > 0 -%}
            All Keywords (flat view)
        {%- else -%}
            Google Trends -- Top Movers
        {%- endif -%}
    </h2>
    <p style="font-size:12px;color:#6b7280;margin:0 0 12px;">Relative search interest (0-100 scale, 100 = peak) &mdash; week-over-week change</p>
    <table style="width:100%;border-collapse:collapse;font-size:13px;">
        <thead><tr style="background:#f8fafc;">
            <th style="padding:8px 10px;text-align:left;font-weight:600;color:#475569;border-bottom:2px solid #e2e8f0;">Keyword</th>
            <th style="padding:8px;text-align:center;font-weight:600;color:#475569;border-bottom:2px solid #e2e8f0;">Interest</th>
            <th style="padding:8px;text-align:center;font-weight:600;color:#475569;border-bottom:2px solid #e2e8f0;">WoW</th>
            <th style="padding:8px;text-align:center;font-weight:600;color:#475569;border-bottom:2px solid #e2e8f0;">4w Avg</th>
        </tr></thead>
        <tbody>
        {% for kw in analysis.google_trends.keywords %}
        <tr>
            <td style="padding:8px 10px;border-bottom:1px solid #f0f0f0;">
                <div style="font-weight:500;">{{ kw.keyword }}</div>
                {% if kw.rising_queries %}
                <div style="font-size:11px;color:#6b7280;margin-top:3px;">Rising: {{ kw.rising_queries | join(', ') }}</div>
                {% endif %}
            </td>
            <td style="padding:8px;border-bottom:1px solid #f0f0f0;text-align:center;">{{ kw.score if kw.score is not none else '-' }}</td>
            <td style="padding:8px;border-bottom:1px solid #f0f0f0;text-align:center;">{{ wow_badge(kw.wow_pct) }}</td>
            <td style="padding:8px;border-bottom:1px solid #f0f0f0;text-align:center;color:#6b7280;font-size:12px;">{{ "%.1f"|format(kw.four_week_avg) if kw.four_week_avg is not none else '-' }}</td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}
