{# ═══════════════════════════════════════════════════════════ #}
{# COMPETITOR INTELLIGENCE                                     #}
{# ═══════════════════════════════════════════════════════════ #}
{% if competitor_data and competitor_data.videos %}
<div style="padding:24px 28px;">
    <div style="font-size:11px;color:#6366f1;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;">Competitor Intelligence</div>
    <h2 style="font-size:20px;font-weight:700;margin:6px 0 4px;color:#1e293b;">What Top Creators Covered This Week</h2>
    <p style="font-size:13px;color:#64748b;margin:0 0 16px;">Tracked {{ competitor_data.summary.total_channels_checked }} channels &middot; {{ competitor_data.summary.total_new_videos }} new videos &middot; {{ competitor_data.summary.relevant_videos }} relevant to your niche</p>

    {% if competitor_data.summary.top_topics %}
    <div style="background:#f0f9ff;border:1px solid #bae6fd;border-radius:8px;padding:12px 16px;margin-bottom:16px;">
        <div style="font-size:11px;font-weight:700;color:#0369a1;letter-spacing:0.3px;">HOT TOPICS ACROSS COMPETITORS:</div>
        <div style="font-size:13px;color:#0c4a6e;margin-top:6px;">
            {% for topic in competitor_data.summary.top_topics[:7] %}
            <span style="display:inline-block;background:#e0f2fe;border-radius:12px;padding:3px 10px;margin:2px 4px 2px 0;font-size:12px;">{{ topic }}</span>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% for category, videos in competitor_data.by_category.items() %}
    {% set relevant_videos = [] %}
    {% for v in videos %}
        {% if v.matched_keywords %}
            {% if relevant_videos.append(v) %}{% endif %}
        {% endif %}
    {% endfor %}

    {% if relevant_videos %}
    <div style="margin-bottom:16px;">
        <div style="font-size:12px;font-weight:700;color:#475569;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;border-bottom:1px solid #e2e8f0;padding-bottom:4px;">
            {{ category | replace('_', ' ') | title }}
        </div>
        {% for video in relevant_videos[:5] %}
        <div style="padding:8px 0;border-bottom:1px solid #f1f5f9;{% if loop.last %}border-bottom:none;{% endif %}">
            <div style="font-size:13px;font-weight:600;color:#1e293b;">
                <a href="{{ video.url }}" style="color:#1e293b;text-decoration:none;">{{ video.title }}</a>
                {% if video.views is defined and video.views %}
                <span style="font-size:10px;font-weight:400;color:#6366f1;margin-left:6px;">{{ "{:,}".format(video.views) }} views</span>
                {% endif %}
            </div>
            <div style="font-size:11px;color:#94a3b8;margin-top:2px;">
                {{ video.channel }} &middot; {{ video.published[:10] if video.published|length > 10 else video.published }}
            </div>
            {% if video.matched_keywords %}
            <div style="margin-top:4px;">
                {% for kw in video.matched_keywords[:4] %}
                <span style="display:inline-block;background:#fef3c7;color:#92400e;border-radius:8px;padding:1px 8px;font-size:10px;margin-right:4px;">{{ kw }}</span>
                {% endfor %}
            </div>
            {% endif %}
            {% if video.transcript_snippet %}
            <div style="font-size:11px;color:#64748b;margin-top:4px;padding:6px 10px;background:#f8fafc;border-radius:4px;line-height:1.4;">
                <span style="font-weight:600;">Transcript:</span> "{{ video.transcript_snippet[:200] }}..."
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% endif %}
    {% endfor %}

    {# ─── BLOG & WEBSITE POSTS ─────────────────────────────────── #}
    {% if competitor_data.blog_posts %}
    <div style="margin-top:16px;margin-bottom:16px;">
        <div style="font-size:11px;font-weight:700;color:#16a34a;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:10px;">Blog &amp; Website Posts</div>
        {% for post in competitor_data.blog_posts[:8] %}
        <div style="padding:8px 12px;margin-bottom:6px;background:#f0fdf4;border-left:3px solid #16a34a;border-radius:0 6px 6px 0;">
            <div style="font-size:13px;font-weight:600;color:#1e293b;">
                <a href="{{ post.url }}" style="color:#1e293b;text-decoration:none;">{{ post.title }}</a>
            </div>
            <div style="font-size:11px;color:#64748b;margin-top:2px;">
                {{ post.channel | default(post.source | default('')) }}
                {% if post.published %} &middot; {{ post.published[:10] if post.published|length > 10 else post.published }}{% endif %}
            </div>
            {% if post.matched_keywords or post.tags %}
            <div style="margin-top:4px;">
                {% for kw in (post.matched_keywords or post.tags)[:4] %}
                <span style="display:inline-block;background:#dcfce7;color:#166534;border-radius:8px;padding:1px 8px;font-size:10px;margin-right:4px;">{{ kw }}</span>
                {% endfor %}
            </div>
            {% endif %}
            {% if post.snippet or post.description %}
            <div style="font-size:11px;color:#64748b;margin-top:4px;padding:4px 8px;background:#fff;border-radius:4px;line-height:1.4;">
                "{{ (post.snippet or post.description)[:200] }}{% if (post.snippet or post.description)|length > 200 %}...{% endif %}"
            </div>
            {% endif %}
        </div>
        {% endfor %}
        {% if competitor_data.blog_posts|length > 8 %}
        <div style="font-size:11px;color:#64748b;margin-top:4px;">+ {{ competitor_data.blog_posts|length - 8 }} more blog posts</div>
        {% endif %}
    </div>
    {% endif %}

    {# Show non-relevant videos from competitors (what else they're covering) #}
    {% set other_videos = [] %}
    {% for v in competitor_data.videos %}
        {% if not v.matched_keywords %}
            {% if other_videos.append(v) %}{% endif %}
        {% endif %}
    {% endfor %}
    {% if other_videos %}
    <div style="background:#f8fafc;border-radius:8px;padding:12px 16px;margin-top:8px;">
        <div style="font-size:11px;font-weight:700;color:#64748b;letter-spacing:0.3px;margin-bottom:6px;">OTHER TOPICS COMPETITORS COVERED:</div>
        {% for video in other_videos[:6] %}
        <div style="font-size:12px;color:#475569;padding:3px 0;">
            <span style="color:#94a3b8;">{{ video.channel }}:</span> {{ video.title[:80] }}{% if video.title|length > 80 %}...{% endif %}
        </div>
        {% endfor %}
        {% if other_videos|length > 6 %}
        <div style="font-size:11px;color:#94a3b8;margin-top:4px;">+ {{ other_videos|length - 6 }} more non-overlapping videos</div>
        {% endif %}
    </div>
    {% endif %}

    {# ─── CONTENT GAP OPPORTUNITIES ──────────────────────────── #}
    {% if other_videos %}
    <div style="background:#fef3c7;border:1px solid #f59e0b;border-radius:8px;padding:14px 16px;margin-top:16px;">
        <div style="font-size:11px;font-weight:700;color:#92400e;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;">Content Gap Opportunities</div>
        <div style="font-size:12px;color:#78350f;line-height:1.5;margin-bottom:8px;">
            These topics are being covered by competitors but may represent gaps in your content library. Consider creating content around them before they become saturated.
        </div>
        {% set gap_topics = [] %}
        {% for video in other_videos[:6] %}
            {% if gap_topics.append(video.title[:60]) %}{% endif %}
        {% endfor %}
        {% for topic in gap_topics %}
        <div style="font-size:12px;color:#92400e;padding:3px 0;">
            <span style="color:#b45309;">&rarr;</span> {{ topic }}{% if topic|length >= 60 %}...{% endif %}
        </div>
        {% endfor %}
        {% if other_videos|length > 6 %}
        <div style="font-size:10px;color:#a16207;margin-top:4px;">+ {{ other_videos|length - 6 }} more uncovered topics</div>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endif %}
